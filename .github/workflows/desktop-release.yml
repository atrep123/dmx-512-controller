name: Desktop Release

on:
  workflow_dispatch:
    inputs:
      channel:
        description: Release channel
        type: choice
        required: true
        options:
          - stable
          - beta
      version:
        description: SemVer without the leading "v" (e.g. 1.2.3)
        required: true
      release_notes:
        description: Optional release notes (markdown/plain text)
        required: false

jobs:
  build-desktop:
    runs-on: windows-latest
    env:
      RELEASE_CHANNEL: ${{ inputs.channel }}
      RELEASE_VERSION: ${{ inputs.version }}
      RELEASE_NOTES: ${{ inputs.release_notes }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install root dependencies
        shell: pwsh
        run: |
          npm install

      - name: Build backend sidecar (PyInstaller)
        shell: pwsh
        run: |
          scripts\build-server-exe.bat

      - name: Install desktop dependencies
        shell: pwsh
        run: |
          cd desktop
          npm install

      - name: Build Tauri bundle
        shell: pwsh
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          cd desktop
          npm run build

      - name: Sign installers (optional)
        if: ${{ secrets.WINDOWS_CERTIFICATE_B64 != '' }}
        shell: pwsh
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE_B64 }}")
          [IO.File]::WriteAllBytes("cert.pfx", $bytes)
          $msi = Get-ChildItem ".\desktop\src-tauri\target\release\bundle\msi\*.msi"
          $exe = Get-ChildItem ".\desktop\src-tauri\target\release\bundle\nsis\*.exe"
          $files = @($msi.FullName, $exe.FullName)
          foreach ($file in $files) {
            & "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe" sign `
              /fd sha256 `
              /tr "http://timestamp.sectigo.com" `
              /td sha256 `
              /f cert.pfx `
              /p "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" `
              $file
          }

      - name: Create release manifest
        shell: pwsh
        env:
          TAURI_UPDATE_SIGNATURE: ${{ secrets.TAURI_UPDATE_SIGNATURE }}
        run: |
          node desktop/scripts/create-release-json.mjs `
            --channel $env:RELEASE_CHANNEL `
            --version $env:RELEASE_VERSION `
            --tag desktop-v$env:RELEASE_VERSION

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-msi-${{ inputs.channel }}-${{ inputs.version }}
          path: desktop/src-tauri/target/release/bundle/msi/*.msi

      - name: Upload NSIS artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-nsis-${{ inputs.channel }}-${{ inputs.version }}
          path: desktop/src-tauri/target/release/bundle/nsis/*.exe

      - name: Upload release manifest
        uses: actions/upload-artifact@v4
        with:
          name: desktop-release-json-${{ inputs.channel }}-${{ inputs.version }}
          path: dist/desktop/${{ inputs.channel }}-release.json
